<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat WebSocket</title>
   <style>
    /* (Seu código de estilo permanece o mesmo) */
   </style>
</head>
<body>
    <h1>Chat WebSocket</h1>
    <div id="userSection">
        <input type="text" id="username" placeholder="Digite seu nome" />
        <button id="registerBtn">Cadastrar</button>
    </div>

    <div id="chatSection">
        <h3>Usuários Conectados</h3>
        <div id="userList"></div>

        <div id="chatBox" class="chatBox">
            <h3>Conversando com <span id="chatWith"></span></h3>
            <div id="messages"></div>
            <input type="text" id="messageInput" placeholder="Digite uma mensagem..." />
            <button id="sendMessageBtn">Enviar</button>
            <!-- Botão para apagar todas as mensagens -->
            <button id="clearChatBtn">Limpar Conversa</button>
        </div>
    </div>

    <script>
    const ws = new WebSocket('wss://chat-2xo1.onrender.com');
    let username = '';
    let targetUser = null;

    // Função para limpar o histórico de mensagens
    function clearChatHistory(user1, user2) {
        const chatKey = `${user1}-${user2}`;
        const reverseChatKey = `${user2}-${user1}`;

        // Limpar o histórico de mensagens do localStorage
        localStorage.removeItem(chatKey);
        localStorage.removeItem(reverseChatKey);

        // Limpar as mensagens exibidas no chat
        document.getElementById('messages').innerHTML = '';
    }

    // Registrar o usuário
    document.getElementById('registerBtn').onclick = () => {
        username = document.getElementById('username').value;
        if (username) {
            localStorage.setItem('username', username); // Salvar nome no localStorage
            ws.send(JSON.stringify({ type: 'register', username }));
            document.getElementById('userSection').style.display = 'none';
            document.getElementById('chatSection').style.display = 'block';
        }
    };

    // Função para iniciar o chat
    function startChat(user) {
        targetUser = user;
        document.getElementById('chatWith').textContent = user;
        document.getElementById('chatBox').style.display = 'block';

        // Carregar histórico de mensagens
        document.getElementById('messages').innerHTML = ''; // Limpar mensagens antigas
        loadMessagesFromLocalStorage(username, user);
    }

    // Vincular a função de limpar conversa ao botão
    document.getElementById('clearChatBtn').onclick = () => {
        if (targetUser) {
            clearChatHistory(username, targetUser);
        }
    };

    // Carregar mensagens do localStorage
    function loadMessagesFromLocalStorage(user1, user2) {
        const chatKey = `${user1}-${user2}`;
        const reverseChatKey = `${user2}-${user1}`;

        // Buscar as mensagens do localStorage
        const chatHistory = JSON.parse(localStorage.getItem(chatKey)) || JSON.parse(localStorage.getItem(reverseChatKey)) || [];

        // Exibir as mensagens carregadas
        chatHistory.forEach(chat => {
            appendMessage(chat.sender, chat.message, chat.sender === username, chat.timestamp, chat.read);
        });

        // Marcar todas as mensagens como "lidas" após abrir o chat
        markMessagesAsRead(user1, user2);
    }

    // Salvar mensagem no localStorage
    function saveMessageToLocalStorage(sender, recipient, message, isReceived) {
        const chatKey = `${sender}-${recipient}`;
        const reverseChatKey = `${recipient}-${sender}`;

        // Verifica se existe um histórico para esse chat ou o contrário
        let chatHistory = JSON.parse(localStorage.getItem(chatKey)) || [];
        const timestamp = new Date().toISOString();

        // Mensagem a ser salva com timestamp e status de visualização
        const messageObject = {
            sender,
            message,
            timestamp,
            read: isReceived ? false : true // Se for uma mensagem recebida, ela ainda não foi lida
        };

        chatHistory.push(messageObject);
        localStorage.setItem(chatKey, JSON.stringify(chatHistory)); 

        // Também guarda o histórico no chat inverso (de recipient para sender)
        let reverseChatHistory = JSON.parse(localStorage.getItem(reverseChatKey)) || [];
        reverseChatHistory.push({ sender, message, timestamp, read: true }); // Recebida já marcada como lida
        localStorage.setItem(reverseChatKey, JSON.stringify(reverseChatHistory)); 
    }

    // Função para adicionar uma mensagem à área de conversa
    function appendMessage(sender, message, isSent, timestamp, readStatus) {
        const messagesDiv = document.getElementById('messages');
        const messageDiv = document.createElement('div');
        messageDiv.classList.add(isSent ? 'sent' : 'received');
        
        const time = new Date(timestamp).toLocaleTimeString();
        const readIcon = readStatus
            ? '<span class="read-icon" style="color: green;">✓</span>' // Ícone verde (visualizada)
            : '<span class="read-icon" style="color: gray;">✓</span>'; // Ícone cinza (não visualizada)

        messageDiv.innerHTML = `${sender} (${time}) ${readIcon}: ${message}`;
        messagesDiv.appendChild(messageDiv);
        messagesDiv.scrollTop = messagesDiv.scrollHeight; // Rolagem automática para o final
    }

    // WebSocket para interação
    ws.onmessage = (event) => {
        const data = JSON.parse(event.data);

        // Atualizar lista de usuários
        if (data.type === 'user_list') {
            const userList = document.getElementById('userList');
            userList.innerHTML = ''; // Limpar lista antes de atualizar
            data.users.forEach(user => {
                const div = document.createElement('div');
                div.classList.add('user');
                div.innerHTML = `${user.username} ${user.status}`;
                div.onclick = () => startChat(user.username); // Iniciar conversa ao clicar
                userList.appendChild(div);
            });
        }

        // Receber mensagem privada
        if (data.type === 'private_message') {
            if (data.from === targetUser) {
                saveMessageToLocalStorage(data.from, username, data.message, true); // Salvar mensagem recebida
                appendMessage(data.from, data.message, false, new Date().toISOString(), false);
            } else {
                alert(`Nova mensagem de ${data.from}`);
            }
        }
    };
    </script>
</body>
</html>
